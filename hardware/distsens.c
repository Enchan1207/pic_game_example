//
// 超音波距離センサ
//
#include "distsens.h"

#include "adc.h"

// clang-format off
/// @brief センサの出力値を距離に変換するテーブル
static const uint16_t _distanceTable[] = {
    0x079D, 0x0778, 0x0753, 0x072E, 0x0709, 0x06E5, 0x06C0, 0x069B,
    0x0676, 0x0651, 0x062C, 0x0608, 0x05E3, 0x05BE, 0x0599, 0x0574,
    0x0550, 0x052B, 0x0506, 0x04E1, 0x04BC, 0x0497, 0x0473, 0x044E,
    0x0429, 0x0404, 0x03DF, 0x03BA, 0x0396, 0x0371, 0x034C, 0x0327,
    0x02E2, 0x02CE, 0x02A2, 0x0293, 0x0284, 0x0275, 0x0266, 0x0233,
    0x0229, 0x0220, 0x0216, 0x020D, 0x0203, 0x01F9, 0x01D4, 0x01CD,
    0x01C6, 0x01BF, 0x01B8, 0x01B2, 0x01AB, 0x01A4, 0x019D, 0x0196,
    0x0190, 0x0166, 0x0161, 0x015D, 0x0159, 0x0155, 0x0150, 0x014C,
    0x0148, 0x0143, 0x013F, 0x013B, 0x0137, 0x0132, 0x012E, 0x0119,
    0x0116, 0x0113, 0x0111, 0x010E, 0x010B, 0x0108, 0x0106, 0x0103,
    0x0100, 0x00FD, 0x00ED, 0x00EB, 0x00E9, 0x00E7, 0x00E5, 0x00E3,
    0x00E1, 0x00DF, 0x00DD, 0x00DB, 0x00D9, 0x00D7, 0x00D5, 0x00D3,
    0x00D1, 0x00CF, 0x00CD, 0x00CB, 0x00C9, 0x00AD, 0x00AC, 0x00AB,
    0x00AA, 0x00A9, 0x00A8, 0x00A7, 0x00A6, 0x00A5, 0x00A4, 0x00A3,
    0x00A2, 0x00A1, 0x00A0, 0x009F, 0x009E, 0x009D, 0x009C, 0x009B,
    0x009B, 0x009A, 0x0099, 0x0098, 0x0097, 0x0096, 0x0095, 0x0093,
    0x0092, 0x0091, 0x0090, 0x008F, 0x008F, 0x008E, 0x008D, 0x008C,
    0x008B, 0x008A, 0x0089, 0x0088, 0x0087, 0x0086, 0x0085, 0x0084,
    0x0083, 0x0082, 0x0081, 0x0080, 0x007F, 0x007E, 0x007D, 0x007C,
    0x007B, 0x007A, 0x0079, 0x0078, 0x006E, 0x006E, 0x006D, 0x006D,
    0x006C, 0x006B, 0x006B, 0x006A, 0x006A, 0x0069, 0x0069, 0x0068,
    0x0067, 0x0067, 0x0066, 0x0066, 0x0065, 0x0064, 0x0064, 0x0063,
    0x0063, 0x0062, 0x0060, 0x005F, 0x005F, 0x005E, 0x005E, 0x005D,
    0x005D, 0x005C, 0x005C, 0x005B, 0x005B, 0x005A, 0x0059, 0x0059,
    0x0058, 0x0058, 0x0057, 0x0057, 0x0056, 0x0056, 0x0055, 0x0054,
    0x0054, 0x0053, 0x0053, 0x0052, 0x0052, 0x0051, 0x0051, 0x0050,
    0x004F, 0x004F, 0x004E, 0x004E, 0x0054, 0x0053, 0x0052, 0x0051,
    0x0050, 0x004F, 0x004E, 0x004D, 0x004D, 0x004C, 0x004B, 0x004A,
    0x0049, 0x0048, 0x0047, 0x0046, 0x0045, 0x0044, 0x0043, 0x0042,
    0x0041, 0x0041, 0x0040, 0x003F, 0x003E, 0x003D, 0x003C, 0x003B,
    0x003A, 0x0039, 0x0038, 0x0037, 0x0036, 0x0035, 0x0035, 0x0034,
    0x0033, 0x0032, 0x0031, 0x0030, 0x002F, 0x002E, 0x002D, 0x002C,
};
// clang-format on

void distsens_init(void) {
    adc_init();
    adc_requestConversion(DistanceSensor);
}

void distsens_requireUpdate(void) {
    adc_requestConversion(DistanceSensor);
}

uint16_t distsens_getDistance(void) {
    uint8_t adcResult = adc_getValue(DistanceSensor);
    uint16_t distance = _distanceTable[adcResult];
    return distance;
}
